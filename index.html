<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mia Kingtide's Ocean Memory Match</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="img/Octopus.svg">
    
    <!-- Apple Touch Icon (for iOS homescreen) -->
    <link rel="apple-touch-icon" href="img/Octopus.svg">
    
    <!-- Web App Manifest for Android/PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ocean Match">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            min-height: 100vh;
        }

        h1, h2, .font-display {
            font-family: 'Fredoka', sans-serif;
        }

        /* --- 3D CARD ANIMATION CORE --- */
        .perspective-1000 {
            perspective: 1000px;
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        /* The Faces */
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden; 
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden; 
        }

        /* The Cover (Blue Sea Pattern) */
        .card-front {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotateY(0deg);
        }

        /* The Creature (Hidden Content) */
        .card-back {
            background-color: white;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #0ea5e9;
        }

        /* Image Styling */
        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center top; 
            display: block;
        }

        /* Mismatch Shake Animation */
        @keyframes shake-flipped {
            0%, 100% { transform: rotateY(180deg) translateX(0); }
            20% { transform: rotateY(180deg) translateX(-8px); }
            40% { transform: rotateY(180deg) translateX(8px); }
            60% { transform: rotateY(180deg) translateX(-4px); }
            80% { transform: rotateY(180deg) translateX(4px); }
        }

        .card.shake .card-inner {
            animation: shake-flipped 0.5s ease-in-out;
            cursor: not-allowed;
        }

        /* Confetti Animation */
        .bubble {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }
        
        .bg-bubble {
            z-index: -1;
            background-color: rgba(255, 255, 255, 0.4);
            animation: rise 15s infinite ease-in;
            bottom: -100px;
        }

        .confetti {
            animation: fall 3s ease-out forwards;
        }
        
        @keyframes rise {
            0% { bottom: -100px; transform: translateX(0); }
            50% { transform: translateX(100px); }
            100% { bottom: 1080px; transform: translateX(-200px); }
        }

        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .text-gold { color: #FBBF24; }
        .text-gray-300 { color: #D1D5DB; }

        /* Match Pulse Animation */
        @keyframes match-pulse {
            0% { transform: rotateY(180deg) scale(1); box-shadow: 0 0 0 0 rgba(77, 208, 225, 0.7); }
            50% { transform: rotateY(180deg) scale(1.05); box-shadow: 0 0 20px 10px rgba(77, 208, 225, 0.4); }
            100% { transform: rotateY(180deg) scale(1); box-shadow: 0 0 0 0 rgba(77, 208, 225, 0); }
        }

        .card.matched .card-inner {
            animation: match-pulse 0.6s ease-out;
        }

        /* Difficulty Button Styles */
        .diff-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .diff-btn:hover { transform: scale(1.05); }
        .diff-btn.active { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .diff-btn-easy { background: #34d399; color: white; }
        .diff-btn-medium { background: #fbbf24; color: white; }
        .diff-btn-hard { background: #f87171; color: white; }

        /* Paused overlay */
        .paused-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            border-radius: 0.5rem;
        }

        /* Preview state - cards shown briefly */
        .card.preview .card-inner {
            transform: rotateY(180deg);
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .card-inner, .bubble, .confetti, .card.matched .card-inner, .card.shake .card-inner {
                animation: none !important;
                transition: none !important;
            }
            .card.flipped .card-inner, .card.preview .card-inner {
                transform: rotateY(180deg);
            }
        }
        .reduced-motion .card-inner, 
        .reduced-motion .bubble, 
        .reduced-motion .confetti {
            animation: none !important;
            transition: transform 0.1s !important;
        }

        /* Keyboard focus styles */
        .card:focus {
            outline: 3px solid #fbbf24;
            outline-offset: 2px;
        }
        .card.selected {
            outline: 3px solid #0ea5e9;
            outline-offset: 2px;
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34d399, #0ea5e9);
            transition: width 0.3s ease;
        }

        /* Match particles */
        @keyframes particle-burst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        .match-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-burst 0.6s ease-out forwards;
        }

        /* Leaderboard modal */
        .leaderboard-entry {
            display: grid;
            grid-template-columns: 30px 1fr 60px 60px;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            align-items: center;
        }
        .leaderboard-entry:nth-child(odd) { background: rgba(6, 182, 212, 0.1); }
        .leaderboard-entry.gold { background: linear-gradient(90deg, rgba(251, 191, 36, 0.3), transparent); }
        .leaderboard-entry.silver { background: linear-gradient(90deg, rgba(156, 163, 175, 0.3), transparent); }
        .leaderboard-entry.bronze { background: linear-gradient(90deg, rgba(180, 83, 9, 0.2), transparent); }

        /* Settings toggle */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.active { background: #0ea5e9; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch.active::after { transform: translateX(20px); }

    </style>
</head>
<body class="overflow-x-hidden relative">

    <!-- Background Bubbles -->
    <div id="bubbles-container" class="fixed inset-0 pointer-events-none overflow-hidden"></div>

    <div class="container mx-auto px-2 py-4 md:py-8 max-w-5xl flex flex-col items-center min-h-screen">
        
        <!-- Header -->
        <header class="text-center mb-6 w-full">
            <h1 class="text-3xl md:text-5xl font-bold text-cyan-900 mb-2 drop-shadow-sm">
                <a href="https://www.amazon.com/stores/Luke-Kilpatrick/author/B0DNBNF2ZK" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="hover:text-cyan-700 underline decoration-2 underline-offset-4 transition-colors">Mia Kingtide's</a>
                <span class="block text-xl md:text-3xl text-cyan-700 mt-1">Ocean Memory Match</span>
            </h1>
            
            <!-- Dashboard -->
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <!-- Stars -->
                <div class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm border border-cyan-200 flex items-center gap-1" id="star-display">
                    <!-- JS will fill this -->
                </div>

                <!-- Timer -->
                <div class="bg-white/90 backdrop-blur-sm px-6 py-2 rounded-full shadow-sm text-cyan-900 font-bold border border-cyan-200 min-w-[100px]">
                    <span id="timer">00:00</span>
                </div>

                <!-- Moves -->
                <div class="bg-white/90 backdrop-blur-sm px-6 py-2 rounded-full shadow-sm text-cyan-900 font-bold border border-cyan-200">
                    Moves: <span id="move-count">0</span>
                </div>
            </div>
            
            <!-- Difficulty Selector -->
            <div class="flex flex-wrap justify-center gap-2 mt-4">
                <button onclick="setDifficulty('easy')" id="btn-easy" class="diff-btn diff-btn-easy">Easy (6)</button>
                <button onclick="setDifficulty('medium')" id="btn-medium" class="diff-btn diff-btn-medium active">Medium (12)</button>
                <button onclick="setDifficulty('hard')" id="btn-hard" class="diff-btn diff-btn-hard">Hard (20)</button>
            </div>

            <div class="flex flex-wrap gap-4 justify-center mt-4">
                <a href="https://pitterpatterdiving.com" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors">
                    Home
                </a>
                <button onclick="restartGame()" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors">
                    Restart Game
                </button>
                <button onclick="togglePause()" id="pause-btn" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors hidden">
                    Pause
                </button>
                <button onclick="showLeaderboard()" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors">
                    Leaderboard
                </button>
                <button onclick="showSettings()" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors">
                    Settings
                </button>
                <button onclick="shareGame()" class="text-sm font-bold text-cyan-700 hover:text-cyan-900 underline decoration-2 underline-offset-4 transition-colors">
                    Share
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full max-w-md mx-auto mt-4">
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p class="text-xs text-cyan-600 mt-1"><span id="pairs-matched">0</span> / <span id="pairs-total">12</span> pairs matched</p>
            </div>
        </header>

        <!-- Game Grid -->
        <div id="game-container" class="relative w-full mx-auto mb-8 overflow-x-auto" role="main" aria-label="Memory game board">
            <div id="game-board" class="grid grid-cols-4 sm:grid-cols-4 md:grid-cols-6 gap-2 sm:gap-3 md:gap-4 w-fit mx-auto perspective-1000">
                <!-- Cards will be injected here by JS -->
            </div>
            <!-- Pause Overlay -->
            <div id="pause-overlay" class="paused-overlay hidden">
                <div class="text-center text-white">
                    <p class="text-3xl font-display font-bold mb-4">Paused</p>
                    <button onclick="togglePause()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-full">Resume</button>
                </div>
            </div>
        </div>
        
        <!-- Best Score Display -->
        <div id="best-score-display" class="text-cyan-700 text-xs md:text-sm text-center pb-4 max-w-lg hidden">
            <span class="font-bold">Best:</span> <span id="best-time">--:--</span> in <span id="best-moves">--</span> moves
        </div>

    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl border-4 border-cyan-300 relative overflow-hidden max-h-[80vh] flex flex-col">
            <div class="absolute top-0 left-0 w-full h-4 bg-cyan-400"></div>
            <h2 class="text-2xl font-display font-bold text-cyan-900 mb-4 mt-4">Leaderboard</h2>
            
            <!-- Difficulty tabs -->
            <div class="flex gap-2 mb-4">
                <button onclick="showLeaderboardTab('easy')" id="lb-tab-easy" class="px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-700">Easy</button>
                <button onclick="showLeaderboardTab('medium')" id="lb-tab-medium" class="px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-700">Medium</button>
                <button onclick="showLeaderboardTab('hard')" id="lb-tab-hard" class="px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-700">Hard</button>
            </div>
            
            <div id="leaderboard-content" class="flex-1 overflow-y-auto">
                <!-- Entries injected by JS -->
            </div>
            
            <button onclick="closeLeaderboard()" class="mt-4 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-full">Close</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl border-4 border-cyan-300 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-4 bg-cyan-400"></div>
            <h2 class="text-2xl font-display font-bold text-cyan-900 mb-6 mt-4">Settings</h2>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-cyan-800 font-bold">Sound Effects</label>
                    <div id="toggle-sound" class="toggle-switch active" onclick="toggleSetting('sound')"></div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-cyan-800 font-bold">Reduced Motion</label>
                    <div id="toggle-motion" class="toggle-switch" onclick="toggleSetting('motion')"></div>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-cyan-800 font-bold">High Contrast</label>
                    <div id="toggle-contrast" class="toggle-switch" onclick="toggleSetting('contrast')"></div>
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-cyan-200">
                <label class="text-cyan-800 font-bold block mb-2">Your Name (for leaderboard)</label>
                <input type="text" id="player-name" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-500" placeholder="Enter your name" maxlength="20">
            </div>
            
            <button onclick="closeSettings()" class="mt-6 w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-full">Save & Close</button>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl transform transition-all border-4 border-cyan-300 relative overflow-hidden">
            <!-- Decorative wave top -->
            <div class="absolute top-0 left-0 w-full h-4 bg-cyan-400"></div>
            
            <h2 class="text-3xl font-display font-bold text-cyan-900 mb-2 mt-4">Ocean Magic!</h2>
            <p class="text-cyan-600 font-bold text-lg mb-6">You matched all the pictures!</p>
            
            <!-- Results Grid -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-cyan-50 p-3 rounded-xl">
                    <p class="text-xs uppercase tracking-wider text-cyan-600 font-bold">Time</p>
                    <p id="final-time" class="text-xl font-bold text-cyan-900">00:00</p>
                </div>
                <div class="bg-cyan-50 p-3 rounded-xl">
                    <p class="text-xs uppercase tracking-wider text-cyan-600 font-bold">Moves</p>
                    <p id="final-moves" class="text-xl font-bold text-cyan-900">0</p>
                </div>
            </div>

            <!-- Star Result -->
            <div class="mb-6" id="modal-stars">
                <p class="text-xs uppercase tracking-wider text-cyan-600 font-bold mb-2">Rating</p>
                <div class="flex justify-center gap-2" id="final-star-container">
                    <!-- Injected via JS -->
                </div>
            </div>
            
            <!-- Name Input (shown if default) -->
            <div id="win-name-input" class="mb-6 hidden">
                <label class="text-xs uppercase tracking-wider text-cyan-600 font-bold block mb-2">Enter Your Name</label>
                <input type="text" id="win-player-name" class="w-full px-4 py-2 border-2 border-cyan-300 rounded-lg focus:outline-none focus:border-cyan-500 text-center" placeholder="Your name" maxlength="20">
            </div>
            
            <div class="flex gap-3 justify-center">
                <button onclick="restartGame()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 flex-1">
                    Play Again
                </button>
                <button onclick="shareScore(document.getElementById('final-time').textContent, moves, starRating)" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                    Share
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CONFIG = {
            totalImagePool: 20,
            pairsToPlay: 12,
            previewDuration: 1000,
            difficulties: {
                easy: { pairs: 6, moveThresholds: [14, 20] },
                medium: { pairs: 12, moveThresholds: [26, 36] },
                hard: { pairs: 20, moveThresholds: [40, 55] }
            }
        };

        let currentDifficulty = 'medium';
        let isPaused = false;
        let pausedTime = 0;

        // --- Sound Effects (Web Audio API) ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0.15, now);

            switch(type) {
                case 'flip':
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'match':
                    osc.frequency.setValueAtTime(523, now);
                    osc.frequency.setValueAtTime(659, now + 0.1);
                    osc.frequency.setValueAtTime(784, now + 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
                    osc.start(now);
                    osc.stop(now + 0.35);
                    break;
                case 'mismatch':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
                    osc.start(now);
                    osc.stop(now + 0.25);
                    break;
                case 'win':
                    const notes = [523, 659, 784, 1047];
                    notes.forEach((freq, i) => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g);
                        g.connect(audioCtx.destination);
                        o.frequency.setValueAtTime(freq, now + i * 0.15);
                        g.gain.setValueAtTime(0.15, now + i * 0.15);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.3);
                        o.start(now + i * 0.15);
                        o.stop(now + i * 0.15 + 0.3);
                    });
                    return;
            }
        }

        // --- Generic Fallback Icons ---
        const fallbackSvgs = [
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><path d="M10 60 Q30 20 80 50 Q95 60 80 70 Q50 80 10 60 Z" fill="#1E88E5"/><circle cx="70" cy="55" r="2" fill="white"/></svg>`,
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><polygon points="50,10 63,40 95,40 70,60 80,90 50,75 20,90 30,60 5,40 37,40" fill="#FFB74D"/></svg>`,
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><ellipse cx="50" cy="60" rx="30" ry="20" fill="#FF7043"/><circle cx="35" cy="45" r="5" fill="white"/><circle cx="65" cy="45" r="5" fill="white"/></svg>`,
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><path d="M20 80 L50 20 L80 80 Q50 90 20 80 Z" fill="#F48FB1"/></svg>`,
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><circle cx="40" cy="40" r="15" fill="#FFCC80"/><circle cx="70" cy="60" r="15" fill="#EF4444"/></svg>`,
            `<svg viewBox="0 0 100 100" class="w-2/3 h-2/3 drop-shadow-md"><path d="M20 40 Q50 -10 80 40 Z" fill="#BA68C8"/></svg>`,
        ];

        const cardBackIcon = `
            <img src="img/Octopus.svg" alt="Octopus" class="w-3/4 h-3/4 object-contain opacity-90" />
        `;

        const filledStar = `<svg class="w-6 h-6 text-gold fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`;
        const emptyStar = `<svg class="w-6 h-6 text-gray-300 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`;

        // --- Game State ---
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let isLocked = false;
        let timerInterval;
        let startTime;
        let gameStarted = false;
        let starRating = 3;

        // --- Difficulty Functions ---
        function setDifficulty(level) {
            currentDifficulty = level;
            CONFIG.pairsToPlay = CONFIG.difficulties[level].pairs;
            
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${level}`).classList.add('active');
            
            const board = document.getElementById('game-board');
            if (level === 'easy') {
                board.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2 sm:gap-3 lg:gap-4 w-fit mx-auto perspective-1000';
            } else if (level === 'hard') {
                board.className = 'grid grid-cols-5 sm:grid-cols-5 lg:grid-cols-8 gap-2 sm:gap-2 lg:gap-3 w-fit mx-auto perspective-1000';
            } else {
                board.className = 'grid grid-cols-4 sm:grid-cols-4 lg:grid-cols-6 gap-2 sm:gap-3 lg:gap-4 w-fit mx-auto perspective-1000';
            }
            
            loadBestScore();
            initGame();
            showCardPreview();
        }

        // --- Pause Functions ---
        function togglePause() {
            if (!gameStarted) return;
            
            isPaused = !isPaused;
            const overlay = document.getElementById('pause-overlay');
            const pauseBtn = document.getElementById('pause-btn');
            
            if (isPaused) {
                pausedTime = Date.now();
                stopTimer();
                overlay.classList.remove('hidden');
                pauseBtn.textContent = 'Resume';
            } else {
                startTime += (Date.now() - pausedTime);
                startTimerInterval();
                overlay.classList.add('hidden');
                pauseBtn.textContent = 'Pause';
            }
        }

        function startTimerInterval() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- LocalStorage Best Score ---
        function getBestScoreKey() {
            return `mia-memory-best-${currentDifficulty}`;
        }

        function loadBestScore() {
            const key = getBestScoreKey();
            const best = localStorage.getItem(key);
            const display = document.getElementById('best-score-display');
            
            if (best) {
                const data = JSON.parse(best);
                document.getElementById('best-time').textContent = data.time;
                document.getElementById('best-moves').textContent = data.moves;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function saveBestScore(time, movesCount) {
            const key = getBestScoreKey();
            const existing = localStorage.getItem(key);
            
            if (existing) {
                const data = JSON.parse(existing);
                if (movesCount < data.moves || (movesCount === data.moves && timeToSeconds(time) < timeToSeconds(data.time))) {
                    localStorage.setItem(key, JSON.stringify({ time, moves: movesCount }));
                    return true;
                }
                return false;
            } else {
                localStorage.setItem(key, JSON.stringify({ time, moves: movesCount }));
                return true;
            }
        }

        function timeToSeconds(timeStr) {
            const [min, sec] = timeStr.split(':').map(Number);
            return min * 60 + sec;
        }

        // --- Card Preview ---
        function showCardPreview() {
            isLocked = true;
            cards.forEach(card => card.classList.add('preview'));
            
            setTimeout(() => {
                cards.forEach(card => card.classList.remove('preview'));
                isLocked = false;
            }, CONFIG.previewDuration);
        }

        // --- Game Logic ---
        function getGameAssets() {
            // 1. Create array of numbers [1, 2, ... 20]
            let pool = Array.from({length: CONFIG.totalImagePool}, (_, i) => i + 1);
            
            // 2. Shuffle the pool to get random selection
            pool.sort(() => Math.random() - 0.5);
            
            // 3. Slice the first 'pairsToPlay' numbers (e.g., get 12 random numbers)
            let selectedNumbers = pool.slice(0, CONFIG.pairsToPlay);
            
            // 4. Duplicate them to make pairs
            let gameNumbers = [...selectedNumbers, ...selectedNumbers];
            
            // 5. Shuffle the final game deck
            gameNumbers.sort(() => Math.random() - 0.5);
            
            return gameNumbers;
        }

        // Smart image loading handler
        // Tries jpg -> webp -> png -> fallback SVG
        function handleImageError(img) {
            const currentSrc = img.src;
            
            if (currentSrc.endsWith('.jpg')) {
                // Try WEBP next
                img.src = currentSrc.replace('.jpg', '.webp');
            } 
            else if (currentSrc.endsWith('.webp')) {
                // Try PNG next
                img.src = currentSrc.replace('.webp', '.png');
            }
            else {
                // Give up and show SVG fallback
                img.style.display = 'none';
                if(img.previousElementSibling) {
                    img.previousElementSibling.classList.remove('opacity-50');
                    img.previousElementSibling.classList.add('opacity-100');
                }
            }
        }

        function initGame() {
            const gameBoard = document.getElementById('game-board');
            const moveDisplay = document.getElementById('move-count');
            
            // Reset State
            stopTimer();
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            isLocked = false;
            gameStarted = false;
            starRating = 3;
            
            moveDisplay.textContent = '0';
            document.getElementById('timer').textContent = '00:00';
            updateStars();
            document.getElementById('win-modal').classList.add('hidden');
            document.querySelectorAll('.confetti').forEach(el => el.remove());

            // Get Random Assets
            const gameItems = getGameAssets();

            // Build Grid
            gameBoard.innerHTML = '';
            gameItems.forEach((imgNumber, index) => {
                const card = document.createElement('div');
                // Slightly smaller cards for hard mode to prevent scrollbars
                const cardSize = currentDifficulty === 'hard' 
                    ? 'card w-[75px] h-[75px] sm:w-[95px] sm:h-[95px] lg:w-[115px] lg:h-[115px] flex-shrink-0 perspective-1000'
                    : 'card w-[80px] h-[80px] sm:w-[100px] sm:h-[100px] lg:w-[120px] lg:h-[120px] flex-shrink-0 perspective-1000';
                card.className = cardSize;
                card.dataset.id = imgNumber; // Used for matching logic
                card.dataset.index = index;

                // Pick a random fallback icon based on the number (consistent per number)
                const fallbackSvg = fallbackSvgs[imgNumber % fallbackSvgs.length];
                
                // START WITH .WEBP (primary format)
                const imgPath = `img/${imgNumber}.webp`;

                card.innerHTML = `
                    <div class="card-inner relative w-full h-full duration-500">
                        <div class="card-front absolute w-full h-full rounded-xl shadow-md border-2 border-white/20 flex items-center justify-center">
                            ${cardBackIcon}
                        </div>
                        <div class="card-back absolute w-full h-full rounded-xl shadow-md bg-white flex items-center justify-center">
                            <!-- Fallback SVG (Shown if image fails) -->
                            <div class="absolute inset-0 flex items-center justify-center z-0 p-2 opacity-50">
                                ${fallbackSvg}
                            </div>
                            <!-- Main Image -->
                            <img 
                                src="${imgPath}" 
                                alt="Image ${imgNumber}" 
                                class="card-img relative z-10 bg-white" 
                                onerror="handleImageError(this)"
                            />
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => flipCard(card));
                gameBoard.appendChild(card);
                cards.push(card);
            });
        }

        function startTimer() {
            initAudio();
            gameStarted = true;
            startTime = Date.now();
            document.getElementById('pause-btn').classList.remove('hidden');
            startTimerInterval();
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function flipCard(card) {
            if (!gameStarted) startTimer();
            if (isLocked || isPaused || card.classList.contains('flipped') || card.classList.contains('matched')) return;

            playSound('flip');
            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                incrementMoves();
                checkForMatch();
            }
        }

        function incrementMoves() {
            moves++;
            document.getElementById('move-count').textContent = moves;
            const thresholds = CONFIG.difficulties[currentDifficulty].moveThresholds;
            if (moves > thresholds[0]) starRating = 2;
            if (moves > thresholds[1]) starRating = 1;
            updateStars();
        }

        function updateStars() {
            const container = document.getElementById('star-display');
            let html = '';
            for (let i = 0; i < 3; i++) {
                html += (i < starRating) ? filledStar : emptyStar;
            }
            container.innerHTML = html;
        }

        function checkForMatch() {
            isLocked = true;
            const [card1, card2] = flippedCards;
            // Compare dataset.id (which is the image number)
            const isMatch = card1.dataset.id === card2.dataset.id;

            if (isMatch) {
                playSound('match');
                disableCards();
            } else {
                playSound('mismatch');
                card1.classList.add('shake');
                card2.classList.add('shake');
                setTimeout(() => {
                    card1.classList.remove('shake');
                    card2.classList.remove('shake');
                    unflipCards();
                }, 800);
            }
        }

        function disableCards() {
            flippedCards.forEach(card => {
                card.classList.add('matched');
                const back = card.querySelector('.card-back');
                back.style.borderColor = '#4DD0E1';
                createMatchParticles(card);
            });
            
            matchedPairs++;
            updateProgress();
            flippedCards = [];
            isLocked = false;

            if (matchedPairs === CONFIG.pairsToPlay) {
                stopTimer();
                setTimeout(showWinModal, 600);
            }
        }

        function unflipCards() {
            flippedCards.forEach(card => card.classList.remove('flipped'));
            flippedCards = [];
            isLocked = false;
        }

        function showWinModal() {
            playSound('win');
            const modal = document.getElementById('win-modal');
            const finalTime = document.getElementById('timer').textContent;
            document.getElementById('final-moves').textContent = moves;
            document.getElementById('final-time').textContent = finalTime;
            
            const isNewBest = saveBestScore(finalTime, moves);
            loadBestScore();
            
            // Show name input if still default
            const nameInput = document.getElementById('win-name-input');
            const winNameField = document.getElementById('win-player-name');
            if (settings.playerName === 'Player') {
                nameInput.classList.remove('hidden');
                winNameField.value = '';
                winNameField.focus();
            } else {
                nameInput.classList.add('hidden');
            }
            
            // Add to leaderboard (will use current name, can be updated on restart)
            const rank = addToLeaderboard(currentDifficulty, settings.playerName, finalTime, moves, starRating);
            
            const starContainer = document.getElementById('final-star-container');
            let html = '';
            for (let i = 0; i < 3; i++) {
                html += (i < starRating) ? filledStar : emptyStar;
            }
            if (isNewBest) {
                html += '<span class="ml-2 text-sm text-cyan-600 font-bold">NEW BEST!</span>';
            }
            if (rank <= 3) {
                html += `<span class="block text-sm text-cyan-600 font-bold mt-1">#${rank} on leaderboard!</span>`;
            }
            starContainer.innerHTML = html;

            modal.classList.remove('hidden');
            fireConfetti();
        }

        function restartGame() {
            // Save name from win modal if entered
            const winNameField = document.getElementById('win-player-name');
            if (winNameField && winNameField.value.trim()) {
                settings.playerName = winNameField.value.trim();
                document.getElementById('player-name').value = settings.playerName;
                saveSettings();
                // Update the last leaderboard entry with the new name
                updateLastLeaderboardName(currentDifficulty, settings.playerName);
            }
            
            isPaused = false;
            document.getElementById('pause-overlay').classList.add('hidden');
            document.getElementById('pause-btn').textContent = 'Pause';
            document.getElementById('pause-btn').classList.add('hidden');
            document.getElementById('win-name-input').classList.add('hidden');
            initGame();
            updateProgress();
            showCardPreview();
        }

        function fireConfetti() {
            const container = document.body;
            const colors = ['#0ea5e9', '#f472b6', '#fbbf24', '#34d399'];
            
            for(let i=0; i<50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti', 'bubble'); 
                const size = Math.random() * 10 + 5;
                const bg = colors[Math.floor(Math.random() * colors.length)];
                
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                confetti.style.backgroundColor = bg;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-20px';
                confetti.style.animationDuration = `${Math.random() * 2 + 2}s`;
                
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
        }

        // --- Background Decoration ---
        function createBubbles() {
            const container = document.getElementById('bubbles-container');
            const bubbleCount = 15;
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble', 'bg-bubble');
                const size = Math.random() * 60 + 20;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.animationDuration = `${Math.random() * 10 + 10}s`;
                bubble.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(bubble);
            }
        }

        // --- Settings ---
        let settings = {
            sound: true,
            motion: false,
            contrast: false,
            playerName: 'Player'
        };

        function loadSettings() {
            const saved = localStorage.getItem('mia-memory-settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
            applySettings();
        }

        function saveSettings() {
            settings.playerName = document.getElementById('player-name').value || 'Player';
            localStorage.setItem('mia-memory-settings', JSON.stringify(settings));
        }

        function applySettings() {
            document.getElementById('toggle-sound').classList.toggle('active', settings.sound);
            document.getElementById('toggle-motion').classList.toggle('active', settings.motion);
            document.getElementById('toggle-contrast').classList.toggle('active', settings.contrast);
            document.getElementById('player-name').value = settings.playerName;
            
            document.body.classList.toggle('reduced-motion', settings.motion);
            document.body.classList.toggle('high-contrast', settings.contrast);
        }

        function toggleSetting(type) {
            settings[type] = !settings[type];
            applySettings();
            saveSettings();
        }

        function showSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            saveSettings();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // --- Leaderboard ---
        function getLeaderboardKey(difficulty) {
            return `mia-memory-leaderboard-${difficulty}`;
        }

        function getLeaderboard(difficulty) {
            const key = getLeaderboardKey(difficulty);
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        let lastLeaderboardDate = null;

        function addToLeaderboard(difficulty, name, time, movesCount, stars) {
            const leaderboard = getLeaderboard(difficulty);
            lastLeaderboardDate = Date.now();
            leaderboard.push({ name, time, moves: movesCount, stars, date: lastLeaderboardDate });
            leaderboard.sort((a, b) => {
                if (a.moves !== b.moves) return a.moves - b.moves;
                return timeToSeconds(a.time) - timeToSeconds(b.time);
            });
            const top10 = leaderboard.slice(0, 10);
            localStorage.setItem(getLeaderboardKey(difficulty), JSON.stringify(top10));
            return top10.findIndex(e => e.date === lastLeaderboardDate) + 1;
        }

        function updateLastLeaderboardName(difficulty, newName) {
            if (!lastLeaderboardDate) return;
            const leaderboard = getLeaderboard(difficulty);
            const entry = leaderboard.find(e => e.date === lastLeaderboardDate);
            if (entry) {
                entry.name = newName;
                localStorage.setItem(getLeaderboardKey(difficulty), JSON.stringify(leaderboard));
            }
        }

        function showLeaderboard() {
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            showLeaderboardTab(currentDifficulty);
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('hidden');
        }

        function showLeaderboardTab(difficulty) {
            ['easy', 'medium', 'hard'].forEach(d => {
                document.getElementById(`lb-tab-${d}`).classList.toggle('ring-2', d === difficulty);
                document.getElementById(`lb-tab-${d}`).classList.toggle('ring-cyan-500', d === difficulty);
            });
            
            const leaderboard = getLeaderboard(difficulty);
            const content = document.getElementById('leaderboard-content');
            
            if (leaderboard.length === 0) {
                content.innerHTML = '<p class="text-center text-cyan-600 py-8">No scores yet! Be the first to play.</p>';
                return;
            }
            
            let html = '<div class="space-y-1">';
            leaderboard.forEach((entry, i) => {
                const medal = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                const rankIcon = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : `${i + 1}.`;
                html += `
                    <div class="leaderboard-entry ${medal}">
                        <span class="font-bold text-cyan-800">${rankIcon}</span>
                        <span class="font-bold text-cyan-900 truncate">${entry.name}</span>
                        <span class="text-cyan-700 text-sm">${entry.time}</span>
                        <span class="text-cyan-700 text-sm">${entry.moves} moves</span>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        // --- Progress Bar ---
        function updateProgress() {
            const percent = (matchedPairs / CONFIG.pairsToPlay) * 100;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('pairs-matched').textContent = matchedPairs;
            document.getElementById('pairs-total').textContent = CONFIG.pairsToPlay;
        }

        // --- Match Particles ---
        function createMatchParticles(card) {
            if (settings.motion) return;
            const rect = card.getBoundingClientRect();
            const colors = ['#0ea5e9', '#34d399', '#fbbf24', '#f472b6'];
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'match-particle';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${rect.left + rect.width / 2}px`;
                particle.style.top = `${rect.top + rect.height / 2}px`;
                particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                particle.style.setProperty('--ty', `${(Math.random() - 0.5) * 100}px`);
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }

        // --- Keyboard Navigation ---
        let selectedCardIndex = 0;

        function setupKeyboardNav() {
            document.addEventListener('keydown', (e) => {
                // Don't intercept keyboard when typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if (isPaused || !cards.length) return;
                
                const cols = getGridCols();
                
                switch(e.key) {
                    case 'ArrowRight':
                        e.preventDefault();
                        selectedCardIndex = Math.min(selectedCardIndex + 1, cards.length - 1);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        selectedCardIndex = Math.max(selectedCardIndex - 1, 0);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedCardIndex = Math.min(selectedCardIndex + cols, cards.length - 1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedCardIndex = Math.max(selectedCardIndex - cols, 0);
                        break;
                    case 'Enter':
                    case ' ':
                        e.preventDefault();
                        if (cards[selectedCardIndex]) {
                            flipCard(cards[selectedCardIndex]);
                        }
                        break;
                }
                updateCardSelection();
            });
        }

        function getGridCols() {
            const board = document.getElementById('game-board');
            const style = getComputedStyle(board);
            const cols = style.gridTemplateColumns.split(' ').length;
            return cols;
        }

        function updateCardSelection() {
            cards.forEach((card, i) => {
                card.classList.toggle('selected', i === selectedCardIndex);
                card.setAttribute('tabindex', i === selectedCardIndex ? '0' : '-1');
                if (i === selectedCardIndex) card.focus();
            });
        }

        // --- Share Game ---
        const booksUrl = 'https://www.amazon.com/stores/Luke-Kilpatrick/author/B0DNBNF2ZK';
        
        function shareGame() {
            const gameUrl = window.location.href.split('?')[0];
            const text = `ðŸ™ Mia's Ocean Memory Match ðŸ™\nA fun ocean-themed memory game!\nCan you match all the sea creatures?\n${gameUrl}\n\nðŸ“š Explore the Mia Kingtide books: ${booksUrl}`;
            
            if (navigator.share) {
                navigator.share({ title: "Ocean Memory Match", text, url: gameUrl });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Link copied to clipboard!');
                });
            }
        }

        // --- Share Score ---
        function shareScore(time, movesCount, stars) {
            const starStr = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);
            const gameUrl = window.location.href.split('?')[0];
            const text = `ðŸ™ Mia's Ocean Memory Match ðŸ™\n${currentDifficulty.toUpperCase()} Mode\nâ±ï¸ ${time} | ðŸŽ¯ ${movesCount} moves\n${starStr}\nCan you beat my score?\n${gameUrl}\n\nðŸ“š Explore the Mia Kingtide books: ${booksUrl}`;
            
            if (navigator.share) {
                navigator.share({ title: "Ocean Memory Match", text, url: gameUrl });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Score copied to clipboard!');
                });
            }
        }

        window.onload = () => {
            loadSettings();
            createBubbles();
            loadBestScore();
            initGame();
            showCardPreview();
            setupKeyboardNav();
            updateProgress();
        };

    </script>
</body>
</html>